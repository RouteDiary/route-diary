<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
                        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.routediary.repository.DiaryRepository">
    <resultMap id="DiariesMap" type="Diary" autoMapping="true">
     <id property="diaryId" column="diary_id" />
     <result property="diaryTitle" column="diary_title"/>
     <result property="diaryWritingTime" column="diary_writing_time"/>
     <result property="diaryModifyingTime" column="diary_modifying_time"/>
     <result property="diaryStartDate" column="diary_start_date"/>
     <result property="diaryEndDate" column="diary_end_date"/>
     <result property="diaryDisclosureFlag" column="diary_disclosure_flag"/>
     <result property="diaryViewCnt" column="diary_view_cnt"/>
     <result property="diaryLikeCnt" column="diary_like_cnt"/>
     <association property="client" javaType="Client" autoMapping="true">
       <id property="clientId" column="client_id"/>
       <result property="clientNickname" column="client_nickname"/>
       <result property="clientStatusFlag" column="client_status_flag"/>
     </association>
   </resultMap>

    <resultMap id="DiaryMap" type="Diary" autoMapping="true">
     <id property="diaryId" column="diary_id" />
     <result property="diaryTitle" column="diary_title"/>
     <result property="diaryWritingTime" column="diary_writing_time"/>
     <result property="diaryModifyingTime" column="diary_modifying_time"/>
     <result property="diaryStartDate" column="diary_start_date"/>
     <result property="diaryEndDate" column="diary_end_date"/>
     <result property="diaryDisclosureFlag" column="diary_disclosure_flag"/>
     <result property="diaryViewCnt" column="diary_view_cnt"/>
     <result property="diaryLikeCnt" column="diary_like_cnt"/>
     <association property="client" javaType="Client" autoMapping="true">
       <id property="clientId" column="client_id"/>
       <result property="clientNickname" column="client_nickname"/>
       <result property="clientStatusFlag" column="client_status_flag"/>
     </association>
     <collection property="routes" column="diary_no" javaType="List" ofType="Route" autoMapping="true" select="selectRoutes"/>
     <collection property="comments" column="diary_no" javaType="List" ofType="Comment" autoMapping="true" select="selectComments"/>
     <collection property="hashtags" column="diary_no" javaType="List" ofType="Hashtag" autoMapping="true" select="selectHashtags"/>
   </resultMap>



	<select id="selectCount" resultType="int">
		SELECT COUNT(*) FROM diaries
	</select>
	
	<select id="selectDiariesByClientId" resultMap="DiariesMap">
				SELECT * 
		  FROM (SELECT d.*
		             , client_nickname
		             , client_status_flag
		             , row_number() OVER (PARTITION BY 1 ORDER BY 1) AS rnum
		          FROM diaries d
		LEFT OUTER JOIN clients c ON (d.client_id = c.client_id)
		          WHERE d.client_id = #{clientId}
		       ORDER BY diary_writing_time DESC)
		 WHERE rnum BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<select id="selectDiaries" resultMap="DiariesMap">
		SELECT * 
		  FROM  (SELECT d.*
		              , client_nickname
		              , client_status_flag
		              , row_number() OVER (PARTITION BY 1 ORDER BY 1) AS rnum
		           FROM diaries d
		LEFT OUTER JOIN clients c ON (d.client_id = c.client_id)
		<if test="hashtags != null">
		LEFT OUTER JOIN routes r ON (d.diary_no = r.diary_no)
		</if>
		          WHERE diary_disclosure_flag = 1  
		<if test="hashtags != null">                    AND
		                diary_title LIKE '%${hashtag}%' OR
		                route_content LIKE '%${hashtag}%'
		</if>
		       ORDER BY #{order} DESC,
				        diary_writing_time DESC)
		  WHERE rnum BETWEEN #{startRow} AND #{endRow}

	</select>
	
	<select id="selectDiary" parameterType="int" resultMap="DiaryMap">
		         SELECT *
		           FROM diaries d
		LEFT OUTER JOIN clients c ON (d.client_id = c.client_id)
		          WHERE d.diary_no = #{diaryNo}
	</select>	
	<select id="selectRoutes" parameterType="int" resultType="Route">
		         SELECT *
		           FROM routes
		          WHERE diary_no = #{diaryNo}
	</select>		
	<select id="selectComments" parameterType="int" resultType="Comment">
		         SELECT *
		           FROM comments
		          WHERE diary_no = #{diaryNo}
	</select>	
	<select id="selectHashtags" parameterType="int" resultType="Hashtag">
		         SELECT *
		           FROM hashtags
		          WHERE diary_no = #{diaryNo}
	</select>			
</mapper>